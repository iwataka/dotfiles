[toplevel]

clone =
  !f() {
    set -e

    repo_name="$1"

    if [ -z $repo_name ]
    then
      repo_name=$(aws codecommit list-repositories |jq -r '.repositories[].repositoryName' |fzf --header="clone repository")
    fi

    info=$(aws codecommit get-repository --repository-name "$repo_name")
    account_id=$(echo "$info" |jq -r .repositoryMetadata.accountId)
    repo_arn=$(echo "$info" |jq -r .repositoryMetadata.Arn)
    grc_url=$(echo ${repo_arn} |sed -r 's/.+:codecommit:(.+):'${account_id}':(.+)/codecommit::\1:\/\/\2/')
    git clone "${grc_url}"
  }; f

plchk =
  !f() {
    set -e

    pipeline_name="$1"

    if [ -z $pipeline_name ]
    then
      pipeline_name=$(aws codepipeline list-pipelines |jq -r '.pipelines[].name' |fzf --header="check pipeline status")
    fi

    echo "${pipeline_name}"
    aws codepipeline get-pipeline-state --name "$pipeline_name" |
      jq -r '.stageStates[]' |
      jq -r '. |walk(if try todate catch false then todate else . end)' |
      jq -r '.stageName,.actionStates[]'
  }; f

plwait =
  !f() {
    set -e

    pipeline_name="$1"

    if [ -z $pipeline_name ]
    then
      pipeline_name=$(aws codepipeline list-pipelines |jq -r '.pipelines[].name' |fzf --header="check pipeline status")
    fi

    echo "waiting ${pipeline_name} end"
    for i in `seq 60`
    do
      inprogress=$(aws codepipeline get-pipeline-state --name "$pipeline_name" |
        jq -r 'reduce .stageStates[].actionStates[] as $state (false; . | $state == "InProgress")')
      if [ "$inprogress" = "false" ]
      then
        break
      fi
      echo -n "."
    done

    echo "done"
  }; f

cfnchk =
  !f() {
    set -e

    stack_name="$1"

    if [ -z $stack_name ]
    then
      stack_name=$(aws cloudformation describe-stacks |jq -r '.Stacks[].StackName' |fzf --header="check CFn stack events")
    fi

    echo "${stack_name}"
    aws cloudformation describe-stack-events --stack-name "$stack_name" |jq -r '.StackEvents[] |select(.ResourceStatus |endswith("FAILED"))'
  }; f

cfndl =
  !f() {
    set -e

    stack_name="$1"

    if [ -z $stack_name ]
    then
      stack_name=$(aws cloudformation describe-stacks |jq -r '.Stacks[].StackName' |fzf --header="DELETE CFn stack")
    fi

    aws cloudformation delete-stack --stack-name "$stack_name"
  }; f

cfnwait =
  !f() {
    set -e

    stack_name="$1"

    if [ -z $stack_name ]
    then
      stack_name=$(aws cloudformation describe-stacks |jq -r '.Stacks[].StackName' |fzf --header="wait CFn stack update")
    fi

    for i in `seq 60`
    do
      status=$(aws cloudformation describe-stacks --stack-name "$stack_name" |jq -r '.Stacks[0].StackStatus')
      echo -n "."
      if [ ! "$status" = "UPDATE_IN_PROGRESS" ]
      then
        break
      fi
      sleep 1
    done

    echo "$status"
  }; f

cfndp =
  !f() {
    set -e

    template_file="$1"
    stack_name="$2"
    parameters="$@"

    if [ -z $template_file ]
    then
      template_file=$(fzf --header="deploy stack template")
    fi

    if [ -z $stack_name ]
    then
      read -p "Stack Name: " stack_name
    fi

    aws cloudformation deploy \
      --template-file $template_file \
      --stack-name $stack_name \
      --parameter-overrides $parameters \
      --capabilities CAPABILITY_NAMED_IAM
  }; f

cfnup =
  !f() {
    set -e

    stack_name="$1"
    template_file="$2"

    if [ -z $stack_name ]
    then
      stack_name=$(aws cloudformation describe-stacks |jq -r '.Stacks[].StackName' |fzf --header="update CFn stack")
    fi

    if [ -z $template_file ]
    then
      template_file=$(fzf --header="select template file to upload")
    fi

    template_body="file://${template_file}"

    parameters=""
    for p in $(aws cloudformation describe-stacks --stack-name $stack_name |jq -r '.Stacks[].Parameters[].ParameterKey')
    do
      parameters="$parameters ParameterKey=$p,UsePreviousValue=true"
    done

    aws cloudformation update-stack \
      --stack-name $stack_name \
      --template-body $template_body \
      --parameters $parameters \
      --capabilities CAPABILITY_NAMED_IAM
  }; f
